---
// Search component for Pagefind integration
---

<!-- Search button trigger -->
<button
  id="search-button"
  type="button"
  class="flex items-center gap-2 px-3 py-2 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md border border-slate-200 dark:border-slate-700 transition-colors"
  aria-label="Search"
>
  <span class="material-symbols-outlined text-base">search</span>
  <span class="hidden sm:inline">Search</span>
  <kbd class="hidden sm:inline-flex items-center gap-1 px-2 py-1 text-xs font-mono bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded">
    <span class="text-xs">âŒ˜</span>K
  </kbd>
</button>

<!-- Search modal -->
<dialog
  id="search-dialog"
  class="backdrop:bg-slate-900/50 backdrop:backdrop-blur-sm bg-transparent p-0 m-0 w-full max-w-2xl rounded-lg shadow-2xl border-0"
>
  <div class="bg-white dark:bg-slate-800 rounded-lg overflow-hidden">
    <div id="pagefind-search" class="pagefind-ui"></div>
  </div>
</dialog>

<style>
  #search-dialog::backdrop {
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(4px);
  }

  /* Pagefind UI customizations for dark mode */
  #search-dialog :global(.pagefind-ui) {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #137fec;
    --pagefind-ui-text: #0f172a;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e2e8f0;
    --pagefind-ui-tag: #f1f5f9;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-image-border-radius: 0.5rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  :global(.dark) #search-dialog :global(.pagefind-ui) {
    --pagefind-ui-text: #f1f5f9;
    --pagefind-ui-background: #1e293b;
    --pagefind-ui-border: #334155;
    --pagefind-ui-tag: #334155;
  }

  /* Override Pagefind input styles */
  #search-dialog :global(.pagefind-ui__search-input) {
    background: var(--pagefind-ui-background);
    color: var(--pagefind-ui-text);
    border-color: var(--pagefind-ui-border);
  }

  #search-dialog :global(.pagefind-ui__search-input:focus) {
    border-color: var(--pagefind-ui-primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(19, 127, 236, 0.1);
  }

  /* Close button styling */
  #search-dialog :global(.pagefind-ui__search-clear) {
    color: var(--pagefind-ui-text);
  }
</style>

<script>
  // Load Pagefind UI
  const baseUrl = (import.meta.env.BASE_URL || '/').replace(/\/$/, '');
  const pagefindPath = `${baseUrl}/_pagefind/`;
  
  async function initializeSearch() {
    const dialog = document.getElementById('search-dialog') as HTMLDialogElement;
    const searchButton = document.getElementById('search-button');
    const container = document.getElementById('pagefind-search');
    
    if (!dialog || !searchButton || !container) return;
    
    // Lazy load Pagefind UI
    let pagefindUI: any = null;
    
    async function loadPagefind() {
      if (pagefindUI) return;

      try {
        // Load CSS first
        if (!document.querySelector('link[href*="pagefind-ui.css"]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = `${pagefindPath}pagefind-ui.css`;
          document.head.appendChild(link);
          await new Promise((resolve) => {
            link.onload = resolve;
            link.onerror = resolve;
          });
        }

        // Load JS as script (UMD bundle)
        if (!(window as any).PagefindUI) {
          const script = document.createElement('script');
          script.src = `${pagefindPath}pagefind-ui.js`;
          document.head.appendChild(script);
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }

        const PagefindUI = (window as any).PagefindUI;
        pagefindUI = new PagefindUI({
          element: container,
          bundlePath: pagefindPath,
          baseUrl: baseUrl + '/',
          showImages: false,
          excerptLength: 15
        });
      } catch (e) {
        if (!container) return;
        container.innerHTML = `
          <div style="padding: 2rem; text-align: center; color: #64748b;">
            <p style="margin-bottom: 0.5rem; font-weight: 500;">Search unavailable</p>
            <p style="font-size: 0.875rem;">Run <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">npm run build</code> first to generate the search index.</p>
          </div>
        `;
      }
    }
    
    // Open dialog
    function openSearch() {
      dialog.showModal();
      loadPagefind().then(() => {
        // Focus search input after a brief delay
        setTimeout(() => {
          if (!container) return;
          const input = container.querySelector('input') as HTMLInputElement;
          input?.focus();
        }, 100);
      });
    }
    
    // Close dialog
    function closeSearch() {
      dialog.close();
    }
    
    // Event listeners
    searchButton.addEventListener('click', openSearch);
    
    // Close on backdrop click
    dialog.addEventListener('click', (e) => {
      const dialogDimensions = dialog.getBoundingClientRect();
      if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
      ) {
        closeSearch();
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      
      // Escape to close
      if (e.key === 'Escape' && dialog.open) {
        closeSearch();
      }
    });
  }
  
  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSearch);
  } else {
    initializeSearch();
  }
  
  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initializeSearch);
</script>

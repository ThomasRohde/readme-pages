---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PrevNext from '../components/PrevNext.astro';
import { getLastModified, formatRelativeTime } from '../utils/last-modified';

export async function getStaticPaths() {
  const pages = await getCollection('pages');
  
  // Sort pages by order field (or title if no order)
  const sortedPages = pages.sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    if (orderA !== orderB) return orderA - orderB;
    return a.data.title.localeCompare(b.data.title);
  });
  
  return sortedPages.map((page, index) => {
    const prev = index > 0 ? sortedPages[index - 1] : null;
    const next = index < sortedPages.length - 1 ? sortedPages[index + 1] : null;
    
    return {
      params: { slug: page.slug },
      props: {
        page,
        prev: prev ? {
          slug: prev.slug,
          title: prev.data.title,
          description: prev.data.description
        } : undefined,
        next: next ? {
          slug: next.slug,
          title: next.data.title,
          description: next.data.description
        } : undefined
      },
    };
  });
}

const { page, prev, next } = Astro.props;
const { Content } = await page.render();

// Get last modified date from git
const lastModifiedDate = getLastModified(`src/content/pages/${page.id}`);
const lastModifiedRelative = formatRelativeTime(lastModifiedDate);
---

<BaseLayout 
  title={`${page.data.title} - Thomas Klok Rohde`} 
  description={page.data.description}
  modifiedTime={lastModifiedDate}
>
  <article class="prose dark:prose-invert max-w-none">
    <div class="mb-6 text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1" title={`Last modified: ${lastModifiedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`}>
      <span class="material-symbols-outlined text-[16px]">update</span>
      Updated {lastModifiedRelative}
    </div>
    <Content />
  </article>
  <PrevNext prev={prev} next={next} collection="pages" />
</BaseLayout>

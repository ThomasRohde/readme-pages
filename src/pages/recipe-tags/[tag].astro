---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Card from '../../components/Card.astro';

export const getStaticPaths = (async () => {
  const recipes = await getCollection('recipes', ({ data }) => !data.draft);

  // Gather all unique tags
  const tags = new Set<string>();
  recipes.forEach(recipe => {
    recipe.data.tags?.forEach(tag => tags.add(tag));
  });

  // Generate a path for each tag
  return Array.from(tags).map(tag => ({
    params: { tag },
    props: {
      recipes: recipes
        .filter(recipe => recipe.data.tags?.includes(tag))
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    }
  }));
}) satisfies GetStaticPaths;

const { tag } = Astro.params;
const { recipes } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;
---

<BaseLayout title={`Recipe Tag: ${tag} - Thomas Klok Rohde`}>
  <div class="max-w-4xl">
    <!-- Back navigation -->
    <nav class="mb-8 animate-fade-up" style="opacity: 0;">
      <a
        href={`${baseUrl}/recipe-tags/`}
        class="group inline-flex items-center text-sm text-ink-muted dark:text-cream-400 hover:text-accent dark:hover:text-gold transition-colors"
      >
        <span class="material-symbols-outlined text-base mr-2 group-hover:-translate-x-1 transition-transform">arrow_back</span>
        All recipe tags
      </a>
    </nav>

    <!-- Page header -->
    <header class="mb-12 animate-fade-up" style="animation-delay: 0.1s; opacity: 0;">
      <div class="flex items-center gap-4 mb-4">
        <div class="w-12 h-px bg-gradient-to-r from-accent to-transparent dark:from-gold"></div>
        <span class="text-xs tracking-[0.3em] uppercase font-medium text-ink-muted dark:text-cream-400">Recipe Tag</span>
      </div>
      <h1 class="font-display text-4xl sm:text-5xl font-bold tracking-tight text-primary-800 dark:text-cream-100 mb-4">
        <span class="text-accent dark:text-gold">{tag}</span>
      </h1>
      <p class="text-lg text-ink-light dark:text-cream-300">
        {recipes.length} {recipes.length === 1 ? 'recipe' : 'recipes'} with this tag
      </p>
    </header>

    <div class="grid gap-6">
      {recipes.map((recipe, index) => (
        <Card
          title={recipe.data.title}
          href={`${baseUrl}/recipes/${recipe.id.replace(/\.(md|mdx)$/, '')}/`}
          date={recipe.data.date}
          description={recipe.data.description}
          tags={recipe.data.tags}
          index={index}
          prepTime={recipe.data.prepTime}
          cookTime={recipe.data.cookTime}
          servings={recipe.data.servings}
          difficulty={recipe.data.difficulty}
        />
      ))}
    </div>
  </div>
</BaseLayout>

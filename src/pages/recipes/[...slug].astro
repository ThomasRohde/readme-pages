---
import { getCollection, render } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import PrevNext from '../../components/PrevNext.astro';
import EditOnGitHub from '../../components/EditOnGitHub.astro';
import { calculateReadingTime } from '../../utils/reading-time';
import { getLastModified, formatRelativeTime } from '../../utils/last-modified';

export async function getStaticPaths() {
  const recipes = await getCollection('recipes', ({ data }) => {
    return !data.draft;
  });
  
  // Sort recipes by date descending (newest first)
  const sortedRecipes = recipes.sort((a, b) => 
    b.data.date.valueOf() - a.data.date.valueOf()
  );
  
  return sortedRecipes.map((recipe, index) => {
    // Previous = newer (index - 1), Next = older (index + 1)
    const prev = index > 0 ? sortedRecipes[index - 1] : null;
    const next = index < sortedRecipes.length - 1 ? sortedRecipes[index + 1] : null;
    
    // Remove file extension from slug
    const slug = recipe.id.replace(/\.(md|mdx)$/, '');
    
    return {
      params: { slug },
      props: {
        recipe,
        prev: prev ? {
          slug: prev.id.replace(/\.(md|mdx)$/, ''),
          title: prev.data.title,
          description: prev.data.description
        } : undefined,
        next: next ? {
          slug: next.id.replace(/\.(md|mdx)$/, ''),
          title: next.data.title,
          description: next.data.description
        } : undefined,
      },
    };
  });
}

const { recipe, prev, next } = Astro.props;
const { Content, headings } = await render(recipe);
const readingTime = calculateReadingTime(recipe.body || '');
const formattedDate = recipe.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const base = import.meta.env.BASE_URL || '/';
const baseWithSlash = base.endsWith('/') ? base : `${base}/`;
const breadcrumbItems = [
  { label: 'Recipes', href: `${baseWithSlash}recipes/` },
  { label: recipe.data.title }
];

// Construct GitHub file path for edit link
const githubFilePath = `src/content/recipes/${recipe.id}`;

// Get last modified date from git
const lastModifiedDate = getLastModified(`src/content/recipes/${recipe.id}`);
const lastModifiedRelative = formatRelativeTime(lastModifiedDate);
const showLastModified = lastModifiedDate.getTime() !== recipe.data.date.getTime();

// Recipe metadata
const { prepTime, cookTime, servings, difficulty } = recipe.data;
const hasMeta = prepTime || cookTime || servings || difficulty;

// Difficulty badge colors
const difficultyColors = {
  easy: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
  medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
  hard: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'
};
---

<ArticleLayout
  title={`${recipe.data.title} - Recipes`}
  description={recipe.data.description || `A recipe from ${formattedDate}`}
  publishedTime={recipe.data.date}
  modifiedTime={lastModifiedDate}
  tags={recipe.data.tags}
  headings={headings}
  breadcrumbItems={breadcrumbItems}
>
  <article class="prose dark:prose-invert max-w-none">
    <header class="mb-8">
      <h1>{recipe.data.title}</h1>
      
      <!-- Recipe metadata bar -->
      {hasMeta && (
        <div class="not-prose flex flex-wrap items-center gap-4 mb-4 p-4 rounded-lg bg-cream-100 dark:bg-surface-dark border border-cream-300 dark:border-border-dark">
          {prepTime && (
            <div class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-accent dark:text-gold text-lg">timer</span>
              <span class="text-ink-muted dark:text-cream-400">Prep:</span>
              <span class="font-medium text-ink dark:text-cream-100">{prepTime}</span>
            </div>
          )}
          {cookTime && (
            <div class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-accent dark:text-gold text-lg">local_fire_department</span>
              <span class="text-ink-muted dark:text-cream-400">Cook:</span>
              <span class="font-medium text-ink dark:text-cream-100">{cookTime}</span>
            </div>
          )}
          {servings && (
            <div class="flex items-center gap-2 text-sm">
              <span class="material-symbols-outlined text-accent dark:text-gold text-lg">group</span>
              <span class="text-ink-muted dark:text-cream-400">Servings:</span>
              <span class="font-medium text-ink dark:text-cream-100">{servings}</span>
            </div>
          )}
          {difficulty && (
            <span class={`px-2.5 py-1 rounded-full text-xs font-medium ${difficultyColors[difficulty]}`}>
              {difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}
            </span>
          )}
        </div>
      )}

      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
        <time datetime={recipe.data.date.toISOString()}>{formattedDate}</time>
        {showLastModified && (
          <span class="flex items-center gap-1" title={`Last modified: ${lastModifiedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`}>
            <span class="material-symbols-outlined text-[16px]">update</span>
            Updated {lastModifiedRelative}
          </span>
        )}
        <span class="flex items-center gap-1">
          <span class="material-symbols-outlined text-[16px]">schedule</span>
          {readingTime}
        </span>
        {recipe.data.tags && recipe.data.tags.length > 0 && (
          <span class="flex flex-wrap gap-2">
            {recipe.data.tags.map(tag => (
              <a 
                href={`${baseWithSlash}recipe-tags/${tag}/`}
                class="inline-block bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded hover:bg-accent/20 dark:hover:bg-gold/20 transition-colors"
              >
                {tag}
              </a>
            ))}
          </span>
        )}
        <div class="ml-auto">
          <EditOnGitHub filePath={githubFilePath} />
        </div>
      </div>
    </header>
    <Content />
  </article>
  <PrevNext prev={prev} next={next} collection="recipes" />
</ArticleLayout>
